<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>Contacts - ELEV8TION</title>

    <!-- Cosmic Design System CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <link href="../css/theme-and-custom.css" rel="stylesheet"/>
    <link href="../css/cosmic-design-system.css" rel="stylesheet"/>
    <link href="../css/cosmic-tokens.css" rel="stylesheet"/>
    <link href="../css/cosmic-utilities.css" rel="stylesheet"/>
    <link href="../css/cosmic-animations.css" rel="stylesheet"/>
    <link href="../css/cosmic-buttons.css" rel="stylesheet"/>
    <link href="../css/cosmic-forms.css" rel="stylesheet"/>
    <link href="../css/cosmic-cards.css" rel="stylesheet"/>
    <link href="../css/cosmic-fix.css" rel="stylesheet"/>
    <!-- Modern Card Styles -->
    <link href="../css/modern-cards.css" rel="stylesheet"/>
</head>
<body>
    <div class="min-h-screen w-full bg-black relative">
        <div class="absolute inset-0 z-0" style="background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.08) 0%, transparent 40%), radial-gradient(circle at 80% 30%, rgba(255,255,255,0.05) 0%, transparent 40%), linear-gradient(120deg, #0f0e17 0%, #1a1b26 100%)"></div>

        <main id="main-content" class="position-relative" style="min-height: 100vh; padding: 2rem;">
            <div class="container-fluid">

                <!-- Page Header -->
                <div class="modern-card mb-4" style="padding: 2rem; border-radius: 24px; cursor: default;">
                    <div class="modern-card-shine"></div>
                    <div class="modern-card-glow"></div>
                    <div class="modern-card-content">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h1 class="h2 mb-2 modern-card-title" style="font-size: 1.75rem;">
                                    <i class="fas fa-address-book mr-2" style="color: #667eea;"></i>
                                    Contacts
                                </h1>
                                <p class="mb-0 modern-card-subtitle">
                                    Manage all your business contacts and client relationships
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <button class="btn btn-primary" onclick="ContactsPage.newContact()">
                                    <i class="fas fa-user-plus mr-2"></i>Add Contact
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts Table -->
                <div id="contacts-table-container"></div>

            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/db.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/navigation.js"></script>
    <script src="../js/components/modals.js"></script>
    <script src="../js/components/tables.js"></script>
    <script src="../js/components/forms.js"></script>

    <!-- Enhancement Modules -->
    <script src="../js/enhancements.js"></script>
    <script src="../js/validation.js"></script>

    <!-- Gradient Button Wrapper -->
    <script src="../js/gradient-button-wrapper.js"></script>
    <script src="../js/integrate-enhancements.js"></script>

    <script>
        const ContactsPage = {
            table: null,

            init: function() {
                if (!localStorage.getItem('isLoggedIn')) {
                    window.location.href = '../index-local.html';
                    return;
                }

                this.loadTable();
            },

            loadTable: function() {
                const contacts = DB.getAll(DB.COLLECTIONS.CONTACTS);

                this.table = DataTable.create('contacts-table-container', {
                    title: 'All Contacts',
                    icon: 'fas fa-users',
                    data: contacts,
                    columns: [
                        {
                            field: 'name',
                            label: 'Name',
                            sortable: true,
                            render: (value, row) => {
                                const initials = value.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="cell-avatar">${initials}</div>
                                        <div class="ml-3">
                                            <div style="color: white; font-weight: 500;">${value}</div>
                                            ${row.company ? `<div style="color: rgba(255,255,255,0.5); font-size: 12px;">${row.company}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        {
                            field: 'email',
                            label: 'Email',
                            sortable: true,
                            render: (value) => value ? `<a href="mailto:${value}" style="color: #667eea;">${value}</a>` : '-'
                        },
                        {
                            field: 'phone',
                            label: 'Phone',
                            sortable: true,
                            render: (value) => value || '-'
                        },
                        {
                            field: 'position',
                            label: 'Position',
                            render: (value) => value || '-'
                        },
                        {
                            field: 'tags',
                            label: 'Tags',
                            render: (value) => {
                                if (!value || value.length === 0) return '-';
                                return value.map(tag =>
                                    `<span class="cell-badge" style="background: rgba(102, 126, 234, 0.2); color: #667eea; margin-right: 4px;">${tag}</span>`
                                ).join('');
                            }
                        },
                        {
                            field: 'created_at',
                            label: 'Added',
                            sortable: true,
                            render: (value) => Utils.formatRelativeTime(value)
                        },
                        {
                            field: 'id',
                            label: 'Actions',
                            width: '200px',
                            render: (value, row) => `
                                <div class="cell-actions">
                                    <button class="btn btn-sm btn-primary" onclick="ContactsPage.viewContact('${value}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="ContactsPage.editContact('${value}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="ContactsPage.deleteContact('${value}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `
                        }
                    ],
                    searchable: true,
                    sortable: true,
                    pagination: true,
                    perPage: 10,
                    actions: [
                        {
                            id: 'export',
                            label: 'Export',
                            icon: 'fas fa-download',
                            class: 'btn-secondary',
                            onClick: () => this.exportContacts()
                        }
                    ],
                    emptyMessage: 'No contacts found. Click "Add Contact" to create your first contact.',
                    onRowClick: (row) => this.viewContact(row.id)
                });
            },

            newContact: function() {
                Modals.form({
                    title: 'New Contact',
                    icon: 'fas fa-user-plus',
                    size: 'lg',
                    fields: [
                        { name: 'name', label: 'Full Name', type: 'text', required: true, placeholder: 'John Doe' },
                        { name: 'email', label: 'Email', type: 'email', placeholder: 'john@example.com' },
                        { name: 'phone', label: 'Phone', type: 'tel', placeholder: '+1 (555) 123-4567' },
                        { name: 'company', label: 'Company', type: 'text', placeholder: 'Acme Corp' },
                        { name: 'position', label: 'Position', type: 'text', placeholder: 'CEO' },
                        { name: 'address', label: 'Address', type: 'textarea', rows: 2 },
                        { name: 'tags', label: 'Tags', type: 'tags', value: [], help: 'Press Enter to add tags' },
                        { name: 'notes', label: 'Notes', type: 'textarea', rows: 3 }
                    ],
                    submitText: 'Create Contact'
                }).then(data => {
                    DB.create(DB.COLLECTIONS.CONTACTS, data);
                    Utils.showToast('Contact created successfully!', 'success');
                    this.table.setData(DB.getAll(DB.COLLECTIONS.CONTACTS));
                }).catch(() => {});
            },

            viewContact: function(id) {
                const contact = DB.getContactWithHistory(id);
                if (!contact) return;

                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Email</h6>
                            <p style="color: white; margin-bottom: 15px;">${contact.email || 'Not provided'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Phone</h6>
                            <p style="color: white; margin-bottom: 15px;">${contact.phone || 'Not provided'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Company</h6>
                            <p style="color: white; margin-bottom: 15px;">${contact.company || 'Not provided'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Position</h6>
                            <p style="color: white; margin-bottom: 15px;">${contact.position || 'Not provided'}</p>
                        </div>
                        ${contact.address ? `
                            <div class="col-12">
                                <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Address</h6>
                                <p style="color: white; margin-bottom: 15px;">${contact.address}</p>
                            </div>
                        ` : ''}
                        ${contact.tags && contact.tags.length > 0 ? `
                            <div class="col-12">
                                <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Tags</h6>
                                <p style="margin-bottom: 15px;">${contact.tags.map(t => `<span class="cell-badge" style="background: rgba(102, 126, 234, 0.2); color: #667eea;">${t}</span>`).join(' ')}</p>
                            </div>
                        ` : ''}
                        ${contact.notes ? `
                            <div class="col-12">
                                <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Notes</h6>
                                <p style="color: white; margin-bottom: 15px;">${contact.notes}</p>
                            </div>
                        ` : ''}
                        <div class="col-12">
                            <h6 style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">Activity Summary</h6>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="color: #667eea; font-size: 24px; font-weight: 700;">${contact.projects?.length || 0}</div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">Projects</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="color: #3dd598; font-size: 24px; font-weight: 700;">${contact.invoices?.length || 0}</div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">Invoices</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="color: #50b5ff; font-size: 24px; font-weight: 700;">${contact.deals?.length || 0}</div>
                                    <div style="color: rgba(255,255,255,0.5); font-size: 12px;">Deals</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                Modals.show({
                    title: contact.name,
                    icon: 'fas fa-user',
                    size: 'lg',
                    body: content,
                    footer: `
                        <button class="btn btn-secondary" onclick="Modals.closeTopModal()">Close</button>
                        <button class="btn btn-primary" onclick="Modals.closeTopModal(); ContactsPage.editContact('${id}')">
                            <i class="fas fa-edit mr-2"></i>Edit
                        </button>
                    `
                });
            },

            editContact: function(id) {
                const contact = DB.get(DB.COLLECTIONS.CONTACTS, id);
                if (!contact) return;

                Modals.form({
                    title: 'Edit Contact',
                    icon: 'fas fa-user-edit',
                    size: 'lg',
                    fields: [
                        { name: 'name', label: 'Full Name', type: 'text', required: true, value: contact.name },
                        { name: 'email', label: 'Email', type: 'email', value: contact.email },
                        { name: 'phone', label: 'Phone', type: 'tel', value: contact.phone },
                        { name: 'company', label: 'Company', type: 'text', value: contact.company },
                        { name: 'position', label: 'Position', type: 'text', value: contact.position },
                        { name: 'address', label: 'Address', type: 'textarea', rows: 2, value: contact.address },
                        { name: 'tags', label: 'Tags', type: 'tags', value: contact.tags || [] },
                        { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, value: contact.notes }
                    ],
                    submitText: 'Update Contact'
                }).then(data => {
                    DB.update(DB.COLLECTIONS.CONTACTS, id, data);
                    Utils.showToast('Contact updated successfully!', 'success');
                    this.table.setData(DB.getAll(DB.COLLECTIONS.CONTACTS));
                }).catch(() => {});
            },

            deleteContact: async function(id) {
                const contact = DB.get(DB.COLLECTIONS.CONTACTS, id);
                if (!contact) return;

                const confirmed = await Utils.confirmDelete(`Are you sure you want to delete ${contact.name}? This action cannot be undone.`);

                if (confirmed) {
                    DB.delete(DB.COLLECTIONS.CONTACTS, id);
                    Utils.showToast('Contact deleted successfully!', 'success');
                    this.table.setData(DB.getAll(DB.COLLECTIONS.CONTACTS));
                }
            },

            exportContacts: function() {
                const contacts = DB.getAll(DB.COLLECTIONS.CONTACTS);
                Utils.downloadJson(contacts, `contacts-export-${new Date().toISOString().split('T')[0]}.json`);
                Utils.showToast('Contacts exported successfully!', 'success');
            }
        };

        $(document).ready(() => ContactsPage.init());
    </script>
</body>
</html>
