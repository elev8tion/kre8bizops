<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>Invoices - ELEV8TION</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <link href="../css/theme-and-custom.css" rel="stylesheet"/>
    <link href="../css/cosmic-design-system.css" rel="stylesheet"/>
    <link href="../css/cosmic-tokens.css" rel="stylesheet"/>
    <link href="../css/cosmic-utilities.css" rel="stylesheet"/>
    <link href="../css/cosmic-animations.css" rel="stylesheet"/>
    <link href="../css/cosmic-buttons.css" rel="stylesheet"/>
    <link href="../css/cosmic-forms.css" rel="stylesheet"/>
    <link href="../css/cosmic-cards.css" rel="stylesheet"/>
    <link href="../css/cosmic-fix.css" rel="stylesheet"/>
    <!-- Modern Card Styles -->
    <link href="../css/modern-cards.css?v=3" rel="stylesheet"/>
</head>
<body>
    <div class="min-h-screen w-full bg-black relative">
        <div class="absolute inset-0 z-0" style="background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.08) 0%, transparent 40%), radial-gradient(circle at 80% 30%, rgba(255,255,255,0.05) 0%, transparent 40%), linear-gradient(120deg, #0f0e17 0%, #1a1b26 100%)"></div>

        <!-- Enhanced Navbar -->
        <div id="navbar-container"></div>
        <main id="main-content" class="position-relative" style="min-height: 100vh; padding: 2rem;">
            <div class="container-fluid">

                <div class="modern-card mb-4" style="padding: 2rem; border-radius: 24px;">
                    <div class="modern-card-shine"></div>
                    <div class="modern-card-glow"></div>
                    <div class="modern-card-content">
                <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h2 mb-2" class="modern-card-title" style="font-size: 1.75rem;">
                                <i class="fas fa-file-invoice-dollar mr-2" style="color: #667eea;"></i>
                                Invoices
                            </h1>
                            <p class="mb-0" class="modern-card-subtitle">
                                Create and manage invoices for your clients
                            </p>
                        </div>
                        <div class="col-md-4 text-right">
                            <button class="btn btn-primary" onclick="InvoicesPage.newInvoice()">
                                <i class="fas fa-plus mr-2"></i>Create Invoice
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Invoice Stats -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="modern-card modern-stat-card" style="padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ffc107;">
                            <div class="modern-card-shine"></div>
                            <div class="modern-card-glow"></div>
                            <div class="modern-card-content">
                                <div class="modern-card-subtitle" style="font-size: 12px; margin-bottom: 5px;">DRAFT</div>
                                <div class="modern-card-value" id="stat-draft">$0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="modern-card modern-stat-card" style="padding: 1.5rem; border-radius: 12px; border-left: 4px solid #50b5ff;">
                            <div class="modern-card-shine"></div>
                            <div class="modern-card-glow"></div>
                            <div class="modern-card-content">
                                <div class="modern-card-subtitle" style="font-size: 12px; margin-bottom: 5px;">SENT</div>
                                <div class="modern-card-value" id="stat-sent">$0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="modern-card modern-stat-card" style="padding: 1.5rem; border-radius: 12px; border-left: 4px solid #fc5a5a;">
                            <div class="modern-card-shine"></div>
                            <div class="modern-card-glow"></div>
                            <div class="modern-card-content">
                                <div class="modern-card-subtitle" style="font-size: 12px; margin-bottom: 5px;">OVERDUE</div>
                                <div class="modern-card-value" id="stat-overdue">$0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="modern-card modern-stat-card" style="padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3dd598;">
                            <div class="modern-card-shine"></div>
                            <div class="modern-card-glow"></div>
                            <div class="modern-card-content">
                                <div class="modern-card-subtitle" style="font-size: 12px; margin-bottom: 5px;">PAID</div>
                                <div class="modern-card-value" id="stat-paid">$0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="invoices-table-container"></div>

            </div>
        </main>
    </div>

    <script src="../js/jquery-3.4.1.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/db.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/navigation.js"></script>
    <script src="../js/components/modals.js"></script>
    <script src="../js/components/tables.js"></script>
    <script src="../js/components/forms.js"></script>

    <script>
        const InvoicesPage = {
            table: null,

            init: function() {
                if (!localStorage.getItem('isLoggedIn')) {
                    window.location.href = '../index-local.html';
                    return;
                }

                this.loadStats();
                this.loadTable();
            },

            loadStats: function() {
                const invoices = DB.getAll(DB.COLLECTIONS.INVOICES);
                const now = new Date();

                const stats = {
                    draft: invoices.filter(i => i.status === 'draft').reduce((sum, i) => sum + (i.total || 0), 0),
                    sent: invoices.filter(i => i.status === 'sent').reduce((sum, i) => sum + (i.total || 0), 0),
                    overdue: invoices.filter(i => i.status === 'sent' && i.due_date && new Date(i.due_date) < now).reduce((sum, i) => sum + (i.total || 0), 0),
                    paid: invoices.filter(i => i.status === 'paid').reduce((sum, i) => sum + (i.total || 0), 0)
                };

                $('#stat-draft').text(Utils.formatCurrency(stats.draft));
                $('#stat-sent').text(Utils.formatCurrency(stats.sent));
                $('#stat-overdue').text(Utils.formatCurrency(stats.overdue));
                $('#stat-paid').text(Utils.formatCurrency(stats.paid));
            },

            loadTable: function() {
                const invoices = DB.getAll(DB.COLLECTIONS.INVOICES);

                this.table = DataTable.create('invoices-table-container', {
                    title: 'All Invoices',
                    icon: 'fas fa-receipt',
                    data: invoices,
                    columns: [
                        {
                            field: 'invoice_number',
                            label: 'Invoice #',
                            sortable: true,
                            render: (value, row) => {
                                const contact = row.contact_id ? DB.get(DB.COLLECTIONS.CONTACTS, row.contact_id) : null;
                                return `
                                    <div>
                                        <div style="color: white; font-weight: 600;">#${value}</div>
                                        ${contact ? `<div style="color: rgba(255,255,255,0.5); font-size: 12px;">${contact.name}</div>` : ''}
                                    </div>
                                `;
                            }
                        },
                        {
                            field: 'total',
                            label: 'Amount',
                            sortable: true,
                            render: (value) => `<span style="color: #667eea; font-weight: 600; font-size: 16px;">${Utils.formatCurrency(value || 0)}</span>`
                        },
                        {
                            field: 'status',
                            label: 'Status',
                            sortable: true,
                            render: (value, row) => {
                                const statuses = {
                                    draft: { label: 'Draft', color: '#ffc107' },
                                    sent: { label: 'Sent', color: '#50b5ff' },
                                    paid: { label: 'Paid', color: '#3dd598' },
                                    cancelled: { label: 'Cancelled', color: '#6c757d' }
                                };

                                const now = new Date();
                                const isOverdue = value === 'sent' && row.due_date && new Date(row.due_date) < now;

                                if (isOverdue) {
                                    return '<span class="cell-badge" style="background: rgba(252, 90, 90, 0.2); color: #fc5a5a;">Overdue</span>';
                                }

                                const status = statuses[value] || statuses.draft;
                                return `<span class="cell-badge" style="background: ${status.color}20; color: ${status.color};">${status.label}</span>`;
                            }
                        },
                        {
                            field: 'issue_date',
                            label: 'Issue Date',
                            sortable: true,
                            render: (value) => value ? Utils.formatDate(value) : '-'
                        },
                        {
                            field: 'due_date',
                            label: 'Due Date',
                            sortable: true,
                            render: (value, row) => {
                                if (!value) return '-';
                                const dueDate = new Date(value);
                                const now = new Date();
                                const isToday = Utils.isToday(dueDate);
                                const isPast = dueDate < now && !isToday && row.status === 'sent';

                                let color = 'rgba(255,255,255,0.8)';
                                let badge = '';

                                if (isPast) {
                                    color = '#fc5a5a';
                                    badge = '<span class="cell-badge" style="background: rgba(252, 90, 90, 0.2); color: #fc5a5a; margin-left: 8px;">OVERDUE</span>';
                                } else if (isToday) {
                                    color = '#ffc107';
                                    badge = '<span class="cell-badge" style="background: rgba(255, 193, 7, 0.2); color: #ffc107; margin-left: 8px;">TODAY</span>';
                                }

                                return `<span style="color: ${color};">${Utils.formatDate(value)}</span>${badge}`;
                            }
                        },
                        {
                            field: 'created_at',
                            label: 'Created',
                            sortable: true,
                            render: (value) => Utils.formatRelativeTime(value)
                        },
                        {
                            field: 'id',
                            label: 'Actions',
                            width: '220px',
                            render: (value) => `
                                <div class="cell-actions">
                                    <button class="btn btn-sm btn-info" onclick="InvoicesPage.viewInvoice('${value}')" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="InvoicesPage.editInvoice('${value}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="InvoicesPage.deleteInvoice('${value}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `
                        }
                    ],
                    searchable: true,
                    pagination: true,
                    perPage: 10,
                    actions: [
                        {
                            id: 'export',
                            label: 'Export',
                            icon: 'fas fa-download',
                            class: 'btn-secondary',
                            onClick: () => this.exportInvoices()
                        }
                    ],
                    emptyMessage: 'No invoices found. Click "Create Invoice" to get started.',
                    onRowClick: (row) => this.viewInvoice(row.id)
                });
            },

            newInvoice: function() {
                const contacts = DB.getAll(DB.COLLECTIONS.CONTACTS);
                const projects = DB.getAll(DB.COLLECTIONS.PROJECTS);

                Modals.form({
                    title: 'New Invoice',
                    icon: 'fas fa-file-invoice',
                    size: 'lg',
                    fields: [
                        { name: 'invoice_number', label: 'Invoice Number', type: 'text', required: true, value: 'INV-' + Date.now().toString().slice(-6) },
                        { name: 'contact_id', label: 'Client', type: 'select', required: true, options: contacts.map(c => ({ value: c.id, label: c.name })) },
                        { name: 'project_id', label: 'Project', type: 'select', options: projects.map(p => ({ value: p.id, label: p.name })) },
                        { name: 'issue_date', label: 'Issue Date', type: 'date', required: true, value: new Date().toISOString().split('T')[0] },
                        { name: 'due_date', label: 'Due Date', type: 'date', required: true },
                        { name: 'status', label: 'Status', type: 'select', required: true, value: 'draft', options: [
                            { value: 'draft', label: 'Draft' },
                            { value: 'sent', label: 'Sent' },
                            { value: 'paid', label: 'Paid' },
                            { value: 'cancelled', label: 'Cancelled' }
                        ]},
                        { name: 'notes', label: 'Notes', type: 'textarea', rows: 2 }
                    ],
                    submitText: 'Continue to Line Items'
                }).then(data => {
                    // Create invoice with line items
                    this.editLineItems(data);
                }).catch(() => {});
            },

            editLineItems: function(invoiceData) {
                const items = invoiceData.items || [];

                const modalContent = `
                    <div class="mb-3">
                        <button class="btn btn-sm btn-primary" onclick="InvoicesPage.addLineItem()">
                            <i class="fas fa-plus mr-1"></i>Add Line Item
                        </button>
                    </div>
                    <div id="line-items-container" class="mb-3"></div>
                    <div class="modern-card" style="padding: 1rem; border-radius: 8px;">
                    <div class="modern-card-shine"></div>
                    <div class="modern-card-glow"></div>
                    <div class="modern-card-content">
                <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tax Rate (%)</label>
                                    <input type="number" id="tax-rate" class="form-control" value="${invoiceData.tax_rate || 0}" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Discount</label>
                                    <input type="number" id="discount" class="form-control" value="${invoiceData.discount || 0}" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-right">
                            <div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">
                                Subtotal: <span id="subtotal-display" style="color: white; font-weight: 600;">$0.00</span>
                            </div>
                            <div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">
                                Tax: <span id="tax-display" style="color: white; font-weight: 600;">$0.00</span>
                            </div>
                            <div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">
                                Discount: <span id="discount-display" style="color: white; font-weight: 600;">$0.00</span>
                            </div>
                            <div style="color: #667eea; font-size: 20px; font-weight: 700;">
                                Total: <span id="total-display">$0.00</span>
                            </div>
                        </div>
                    </div>
                `;

                const modal = Modals.custom({
                    title: 'Invoice Line Items',
                    content: modalContent,
                    size: 'xl',
                    buttons: [
                        {
                            text: 'Cancel',
                            class: 'btn-secondary',
                            onClick: () => modal.close()
                        },
                        {
                            text: 'Save Invoice',
                            class: 'btn-primary',
                            onClick: () => {
                                const finalData = {
                                    ...invoiceData,
                                    items: window.currentLineItems || [],
                                    tax_rate: parseFloat($('#tax-rate').val()) || 0,
                                    discount: parseFloat($('#discount').val()) || 0,
                                    subtotal: window.currentSubtotal || 0,
                                    tax: window.currentTax || 0,
                                    total: window.currentTotal || 0
                                };

                                if (invoiceData.id) {
                                    DB.update(DB.COLLECTIONS.INVOICES, invoiceData.id, finalData);
                                    Utils.showToast('Invoice updated successfully!', 'success');
                                } else {
                                    DB.create(DB.COLLECTIONS.INVOICES, finalData);
                                    Utils.showToast('Invoice created successfully!', 'success');
                                }

                                this.loadStats();
                                this.loadTable();
                                modal.close();
                            }
                        }
                    ]
                });

                // Initialize line items
                window.currentLineItems = items;
                this.renderLineItems();
                this.calculateTotals();

                // Bind events
                $('#tax-rate, #discount').on('input', () => this.calculateTotals());
            },

            addLineItem: function() {
                window.currentLineItems = window.currentLineItems || [];
                window.currentLineItems.push({
                    description: '',
                    quantity: 1,
                    rate: 0
                });
                this.renderLineItems();
                this.calculateTotals();
            },

            removeLineItem: function(index) {
                window.currentLineItems.splice(index, 1);
                this.renderLineItems();
                this.calculateTotals();
            },

            renderLineItems: function() {
                const items = window.currentLineItems || [];
                const html = items.map((item, index) => `
                    <div class="modern-card mb-2" style="padding: 1rem; border-radius: 8px;">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" placeholder="Description"
                                    value="${item.description}" onchange="InvoicesPage.updateLineItem(${index}, 'description', this.value)">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Qty"
                                    value="${item.quantity}" min="0" step="0.01" onchange="InvoicesPage.updateLineItem(${index}, 'quantity', this.value)">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Rate"
                                    value="${item.rate}" min="0" step="0.01" onchange="InvoicesPage.updateLineItem(${index}, 'rate', this.value)">
                            </div>
                            <div class="col-md-2">
                                <div style="color: white; font-weight: 600;">${Utils.formatCurrency(item.quantity * item.rate)}</div>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-danger" onclick="InvoicesPage.removeLineItem(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                $('#line-items-container').html(html || '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No line items. Click "Add Line Item" to start.</div>');
            },

            updateLineItem: function(index, field, value) {
                if (field === 'quantity' || field === 'rate') {
                    window.currentLineItems[index][field] = parseFloat(value) || 0;
                } else {
                    window.currentLineItems[index][field] = value;
                }
                this.renderLineItems();
                this.calculateTotals();
            },

            calculateTotals: function() {
                const items = window.currentLineItems || [];
                const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                const taxRate = parseFloat($('#tax-rate').val()) || 0;
                const discount = parseFloat($('#discount').val()) || 0;
                const tax = (subtotal - discount) * (taxRate / 100);
                const total = subtotal + tax - discount;

                window.currentSubtotal = subtotal;
                window.currentTax = tax;
                window.currentTotal = total;

                $('#subtotal-display').text(Utils.formatCurrency(subtotal));
                $('#tax-display').text(Utils.formatCurrency(tax));
                $('#discount-display').text(Utils.formatCurrency(discount));
                $('#total-display').text(Utils.formatCurrency(total));
            },

            viewInvoice: function(id) {
                const invoice = DB.get(DB.COLLECTIONS.INVOICES, id);
                if (!invoice) return;

                const contact = invoice.contact_id ? DB.get(DB.COLLECTIONS.CONTACTS, invoice.contact_id) : null;
                const project = invoice.project_id ? DB.get(DB.COLLECTIONS.PROJECTS, invoice.project_id) : null;

                const lineItemsHtml = (invoice.items || []).map(item => `
                    <tr>
                        <td style="color: white;">${item.description}</td>
                        <td style="color: rgba(255,255,255,0.8); text-align: center;">${item.quantity}</td>
                        <td style="color: rgba(255,255,255,0.8); text-align: right;">${Utils.formatCurrency(item.rate)}</td>
                        <td style="color: white; font-weight: 600; text-align: right;">${Utils.formatCurrency(item.quantity * item.rate)}</td>
                    </tr>
                `).join('');

                const content = `
                    <div class="modern-card" style="padding: 2rem; border-radius: 12px;">
                    <div class="modern-card-shine"></div>
                    <div class="modern-card-glow"></div>
                    <div class="modern-card-content">
                <div class="row mb-4">
                            <div class="col-md-6">
                                <h3 style="color: #667eea; font-weight: 700;">Invoice #${invoice.invoice_number}</h3>
                                ${contact ? `<div style="color: white; font-size: 18px; margin-top: 8px;">${contact.name}</div>` : ''}
                                ${contact && contact.company ? `<div class="modern-card-subtitle">${contact.company}</div>` : ''}
                            </div>
                            <div class="col-md-6 text-right">
                                <div style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">Issue Date: <span style="color: white;">${Utils.formatDate(invoice.issue_date)}</span></div>
                                <div style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">Due Date: <span style="color: white;">${Utils.formatDate(invoice.due_date)}</span></div>
                                ${project ? `<div style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">Project: <span style="color: white;">${project.name}</span></div>` : ''}
                            </div>
                        </div>

                        <table class="table" style="color: rgba(255,255,255,0.8);">
                            <thead>
                                <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                                    <th>Description</th>
                                    <th style="text-align: center;">Quantity</th>
                                    <th style="text-align: right;">Rate</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lineItemsHtml}
                            </tbody>
                        </table>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                ${invoice.notes ? `<div class="modern-card-subtitle">Notes:<br/><span style="color: white;">${invoice.notes}</span></div>` : ''}
                            </div>
                            <div class="col-md-6">
                                <div class="text-right">
                                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">Subtotal: <span style="color: white; font-weight: 600;">${Utils.formatCurrency(invoice.subtotal || 0)}</span></div>
                                    ${invoice.tax ? `<div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">Tax (${invoice.tax_rate}%): <span style="color: white; font-weight: 600;">${Utils.formatCurrency(invoice.tax)}</span></div>` : ''}
                                    ${invoice.discount ? `<div style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">Discount: <span style="color: white; font-weight: 600;">-${Utils.formatCurrency(invoice.discount)}</span></div>` : ''}
                                    <div style="color: #667eea; font-size: 24px; font-weight: 700; margin-top: 12px;">Total: ${Utils.formatCurrency(invoice.total || 0)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                Modals.custom({
                    title: 'Invoice Details',
                    content: content,
                    size: 'xl',
                    buttons: [
                        {
                            text: 'Edit',
                            class: 'btn-secondary',
                            onClick: (modal) => {
                                modal.close();
                                this.editInvoice(id);
                            }
                        },
                        {
                            text: 'Close',
                            class: 'btn-primary',
                            onClick: (modal) => modal.close()
                        }
                    ]
                });
            },

            editInvoice: function(id) {
                const invoice = DB.get(DB.COLLECTIONS.INVOICES, id);
                if (!invoice) return;

                const contacts = DB.getAll(DB.COLLECTIONS.CONTACTS);
                const projects = DB.getAll(DB.COLLECTIONS.PROJECTS);

                Modals.form({
                    title: 'Edit Invoice',
                    icon: 'fas fa-file-invoice',
                    size: 'lg',
                    fields: [
                        { name: 'invoice_number', label: 'Invoice Number', type: 'text', required: true, value: invoice.invoice_number },
                        { name: 'contact_id', label: 'Client', type: 'select', required: true, value: invoice.contact_id, options: contacts.map(c => ({ value: c.id, label: c.name })) },
                        { name: 'project_id', label: 'Project', type: 'select', value: invoice.project_id, options: projects.map(p => ({ value: p.id, label: p.name })) },
                        { name: 'issue_date', label: 'Issue Date', type: 'date', required: true, value: invoice.issue_date },
                        { name: 'due_date', label: 'Due Date', type: 'date', required: true, value: invoice.due_date },
                        { name: 'status', label: 'Status', type: 'select', required: true, value: invoice.status, options: [
                            { value: 'draft', label: 'Draft' },
                            { value: 'sent', label: 'Sent' },
                            { value: 'paid', label: 'Paid' },
                            { value: 'cancelled', label: 'Cancelled' }
                        ]},
                        { name: 'notes', label: 'Notes', type: 'textarea', rows: 2, value: invoice.notes }
                    ],
                    submitText: 'Continue to Line Items'
                }).then(data => {
                    data.id = id;
                    data.items = invoice.items;
                    data.tax_rate = invoice.tax_rate;
                    data.discount = invoice.discount;
                    this.editLineItems(data);
                }).catch(() => {});
            },

            deleteInvoice: async function(id) {
                const invoice = DB.get(DB.COLLECTIONS.INVOICES, id);
                if (!invoice) return;

                const confirmed = await Utils.confirmDelete(`Are you sure you want to delete invoice #${invoice.invoice_number}?`);

                if (confirmed) {
                    DB.delete(DB.COLLECTIONS.INVOICES, id);
                    Utils.showToast('Invoice deleted successfully!', 'success');
                    this.loadStats();
                    this.loadTable();
                }
            },

            exportInvoices: function() {
                const invoices = DB.getAll(DB.COLLECTIONS.INVOICES);
                Utils.downloadJson(invoices, `invoices-export-${new Date().toISOString().split('T')[0]}.json`);
                Utils.showToast('Invoices exported successfully!', 'success');
            }
        };

        $(document).ready(() => InvoicesPage.init());
    </script>

    <!-- Enhancement Modules -->
    <script src="../js/enhancements.js"></script>
    <script src="../js/validation.js"></script>

    <!-- Gradient Button Wrapper -->
    <script src="../js/gradient-button-wrapper.js"></script>
    <script src="../js/integrate-enhancements.js"></script>
    <!-- Load Navbar -->
    <script>
        fetch('../components/enhanced-navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
            });
    </script>
</body>
</html>
